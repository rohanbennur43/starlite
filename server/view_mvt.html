<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Local MVT Viewer Points, Lines, Polygons</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { width: 100vw; height: 100vh; }
</style>
</head>
<body>

<div id="map"></div>

<script>
// Log all network requests made by fetch
const origFetch = window.fetch;
window.fetch = async function(...args) {
  console.log("[Fetch] Request", args[0]);
  try {
    const resp = await origFetch(...args);
    console.log("[Fetch] Response", args[0], resp.status, resp.headers.get("Content-Type"));
    return resp;
  } catch (err) {
    console.error("[Fetch] ERROR", args[0], err);
    throw err;
  }
};

// Create the map
const map = new maplibregl.Map({
  container: "map",
  style: {
    version: 8,
    sources: {
      basemap: {
        type: "raster",
        tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
        tileSize: 256
      },
      local: {
        type: "vector",
        tiles: ["http://127.0.0.1:5000/TIGER2018_COUNTY/{z}/{x}/{y}.mvt"],
        // tiles: ["http://127.0.0.1:5000/TIGER2018_PLACE/{z}/{x}/{y}.mvt"],
        // tiles: ["http://127.0.0.1:5000/roads/{z}/{x}/{y}.mvt"],

        minzoom: 0,
        maxzoom: 14
      }
    },
    layers: [
      {
        id: "basemap",
        type: "raster",
        source: "basemap"
      },
      // {
      //   id: "layer0-fill",
      //   type: "fill",
      //   source: "local",
      //   "source-layer": "layer0",
      //   paint: {
      //     "fill-color": "#0080ff",
      //     "fill-opacity": 0.25
      //   }
      // },
      {
        id: "layer0-outline",
        type: "line",
        source: "local",
        "source-layer": "layer0",
        paint: {
          "line-color": "#003366",
          "line-width": 1.5,
          "line-opacity": 0.9
        }
      },
      {
        id: "layer0-lines",
        type: "line",
        source: "local",
        "source-layer": "layer0",
        paint: {
          "line-color": "#ff6600",
          "line-width": 2.0,
          "line-opacity": 0.9
        },
        filter: ["==", "$type", "LineString"]
      },
      {
        id: "layer0-points",
        type: "circle",
        source: "local",
        "source-layer": "layer0",
        paint: {
          "circle-radius": 4,
          "circle-color": "#ff0000",
          "circle-stroke-width": 1,
          "circle-stroke-color": "#ffffff",
          "circle-opacity": 0.9
        },
        filter: ["==", "$type", "Point"]
      }
    ]
  },
  center: [-120, 37],
  zoom: 5
});

map.addControl(new maplibregl.NavigationControl());

// Log all map data events
map.on("data", e => {
  if (e.sourceId === "local") {
    console.log("[Maplibre data]", e);
  }
});

// Log detailed tile events
map.on("sourcedata", e => {
  if (e.sourceId === "local") {
    console.log("[Tile event] state", e.tile && e.tile.state, "coord", e.tile && e.tile.coord, e);
  }
});

// Log map errors
map.on("error", e => {
  console.error("[Maplibre error]", e);
});

// Log loading events
map.on("dataloading", e => {
  if (e.sourceId === "local") {
    console.log("[Loading tile]", e);
  }
});

</script>
</body>
</html>
